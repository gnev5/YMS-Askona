# План миграции БД для исправления критических проблем

## Проблемы текущей структуры

1. **TimeSlot не привязаны к датам** - содержат только day_of_week
2. **Дублирование записей** - одна запись создает несколько Booking
3. **Потеря связей при регенерации слотов** - все слоты удаляются
4. **Отсутствие журнала слотов** - нет точечного управления

## Новая структура

### 1. TimeSlot (обновленная)
- `slot_date` - конкретная дата вместо day_of_week
- `is_available` - возможность отключить слот
- `created_at/updated_at` - журнал изменений

### 2. Booking (упрощенная)
- Одна запись = одна перевозка
- Убраны поля: time_slot_id, booking_date, group_id
- Добавлен статус записи

### 3. BookingTimeSlot (новая)
- Связь многие-ко-многим между Booking и TimeSlot
- Позволяет одной записи занимать несколько слотов

## План миграции

### Этап 1: Создание новых таблиц
1. Создать новые модели в models.py
2. Создать миграцию Alembic
3. Применить миграцию

### Этап 2: Миграция данных
1. Создать скрипт миграции данных
2. Перенести существующие TimeSlot в новый формат
3. Объединить дублированные Booking в одну запись
4. Создать связи BookingTimeSlot

### Этап 3: Обновление API
1. Обновить endpoints для работы с новой структурой
2. Добавить endpoint для генерации слотов на 4 недели
3. Добавить журнал слотов с возможностью точечного управления

### Этап 4: Обновление фронтенда
1. Адаптировать календарь под новую структуру
2. Обновить формы создания записей
3. Добавить интерфейс управления слотами

## Новые API endpoints

### Управление слотами
- `GET /api/time-slots/journal` - журнал слотов с фильтрацией
- `POST /api/time-slots/generate` - генерация слотов на период
- `PUT /api/time-slots/{id}/availability` - включить/отключить слот
- `DELETE /api/time-slots/{id}` - удалить конкретный слот

### Управление записями
- `POST /api/bookings` - создание записи (упрощенное)
- `GET /api/bookings/{id}/slots` - получить слоты записи
- `PUT /api/bookings/{id}/slots` - изменить слоты записи

## Преимущества новой структуры

1. **Сохранение связей** - записи не теряются при изменении расписания
2. **Гибкость** - одна запись может занимать любое количество слотов
3. **Журнал** - полная история изменений слотов
4. **Точечное управление** - можно управлять отдельными слотами
5. **Масштабируемость** - легко добавлять новые функции
