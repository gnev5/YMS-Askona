# YMS-2 - масштабная доработка структуры и логики записи
Давай сделаем план масштабной доработки. Запиши его как задачу в файл YMS-2.md в каталог dev_tasks
## Модификация структуры данных
### 1. Объекты
Добавить справочник "Объекты" (ID, Наименование, тип (Склад, Производство, Торговая точка, ПВЗ, Прочее), адрес) 
Занести записи: Обухово (склад), Аксон(склад),
### 2. Доки
Записи в справочнике доков должны быть привязаны к конкретному складу.
Все ранее заведенные склады в базе присвоить складу Обухово
Добавить свойство "Тип" значения: Универсальный (по умолчанию), Вход, Выход.
Добавить свойство "**Доступные зоны**". (связь многие-ко-многим со справочником "Зоны")
* Если у дока это свойство не заполнено, он считается универсальным по Зонам.
* Если заполнено, он доступен только для тех Зон, которые в нем указаны.
Добавить свойство: **"Доступные типы перевозок"** (связь многие-ко-многим со справочником "Типы перевозки").
  - Если у дока это свойство не заполнено, он считается универсальным по типу перевозки.
  - Если заполнено, он доступен только для тех типов перевозок, которые в нем указаны.

### 3. Тип перевозки
Добавить поставщику свойство "Тип перевозки" - связь 1-1 с значением из справочника "Типы перевозки" (существующим поставщикам присвоить существующее значение "Закупная")
### 4. Мои бронирования
В журнал Мои бронирования выводить связанное по поставщику поле с названием типа перевозки

### 5. Лимиты ПРР
Добавить таблицу настроек времени на погрузочно-разгрузочные работы (ПРР)
поля: Объект - обязательное, поставщик - не обязательное, Тип перевозки - не обязательное, Тип ТС - не обязательное , длительность (мин) - число, обязательное

## Изменения в процессе записи
В левом меню кнопка Запись на ПРР раскрывается на два подпункта: 
-Вход/поставка
-Выход/отгрузка

### Вход/поставка
При зажатии на Вход/поставка открывается форма выбора Объекта (только тип Склад) - запоминается для сессии и автоподставляется последее используемое
А так же поле для выбора поставщика.

Кнопка - запланировать поставку:
Открывается календарь доступных интервалов. Начиная с текущей даты + 7 дней вперед и возможностью плавной прокрутки вправо и влево.
Доступные интервалы выводятся только: 
- по докам привязанным к выбранному Объекту, 
- типу дока - имеющим значение Универсальный или Вход
- Типам дока, не имеющим привязку ни к одной зоне, или если такая привязка имеется -только к той зоне, свойство которой указано у поставщика.
При выборе временного интервала открывается форма записи:
1. Транспортный лист (она же Транспортная накладная) - обязательно
2. Объем - обязательно
3. Госномер - не обязательно
4. Водитель - не обязательно
5. Телефон водителя- не обязательно
Остальные значения для записи были определены на предыдущих шагах.
Например Зона, Тип перевозки, поставщик, Склад.

Бронирование интервала:
Бронирование происходит по существующей схеме.
Нужно добавить условие, предпочтительного выбора дока с типом Вход, а затем уже универсальный.
При бронировании слота, его длительность **динамически рассчитывается** на основе данных из новой таблицы настроек. Система должна найти наиболее точное совпадение (например, Объект + Поставщик + Тип перевозки + Тип ТС) и взять оттуда значение. Если точного совпадения нет, поиск идет по менее специфичным правилам (например, только Объект + Тип перевозки). 
Это нужно учесть при отображении занятости в календаре: один слот бронирования может занимать несколько стандартных ячеек календаря (например, если ячейки по 30 минут, а ПРР длится 90 минут).
### Выход/отгрузка
При зажатии на Выход/отгрузка открывается форма выбора Объекта (только типы Склад) - запоминается для сессии и автоподставляется последее используемое
Поле для выбора Типа перевозки.
Поле выбора поставщика - сделать "Аскона" **значением по умолчанию** для процесса "Выход/отгрузка" (нужно добавить в справочник поставщиков)

Кнопка - запланировать отгрузку:
Открывается календарь доступных интервалов.
Доступные интервалы выводятся только: 
- по докам привязанным к выбранному Объекту, 
- типу дока - имеющим значение Универсальный или Выход
- Типам перевозки, не имеющим привязку ни к одному из типов или ,если такая привязка имеется -только к тому Типу перевозки, который указан при выборе на предыдущем шаге. 
- Типам дока, не имеющим привязку ни к одной зоне или, если такая привязка имеется -только к той зоне, свойство которой указано у поставщика.
При выборе временного интервала открывается форма записи:
1. Транспортный лист (она же Транспортная накладная) - обязательно
2. Объем - обязательно
3. Город доставки (новый тектовый параметр)
4. Госномер - не обязательно
5. Водитель - не обязательно
6. Телефон водителя- не обязательно
Остальные значения для записи были определены на предыдущих шагах.
Например Зона, Тип перевозки, поставщик, Склад.

Бронирование интервала:
бронирование происходит по существующей схеме.
Нужно добавить условие, предпочтительного выбора дока с типом Выход, а затем уже универсальный.

## Прочие улучшения
### Улучшение юзабилити календаря
- Начинать календарь с текущей даты, но выделять "рекомендуемые" дни (через 7 дней)
- Добавить быстрые кнопки: "Сегодня", "Завтра", "Через неделю"
- Показывать причины недоступности интервалов при наведении
- Добавить индикаторы загруженности доков

### Добавление валидации и проверок
**Необходимые проверки:**
- Проверка конфликтов бронирований - например, если бронирование не помещается в интервал - выдавать предупреждение и рекомендации
- Валидация транспортных листов  - (уникальность, Если добавляется уже существующее значение, нужно добавить "/" и новый порядковый номер. Учесть уже существующие дубли с номерами после слеша)
- Проверка доступности дока в выбранное время

### Оптимизация процесса записи
**Предложение:** Ввести "быстрый режим" для повторяющихся поставок:
- Сохранение шаблонов поставок
- Автозаполнение на основе предыдущих записей
- Пакетное бронирование для регулярных поставок

### Улучшения в настройках времени ПРР
- Добавить приоритеты настроек (более специфичные правила переопределяют общие)
- Ввести валидацию пересечения настроек
- Добавить возможность наследования настроек (объект → зона → поставщик)
## Предлагаемая последовательность реализации

### Этап 1: Базовая структура
1. Создание справочника "Объекты"
2. Обновление структуры доков (привязка к объектам, типы)
3. Обновление поставщиков (тип перевозки)
4. Создание таблицы настроек времени ПРР
### Этап 2: Логика фильтрации
1. Реализация базовой фильтрации по объектам и типам доков
2. Добавление фильтрации по зонам и типам перевозки
3. Тестирование комбинаций фильтров
### Этап 3: Интерфейс и юзабилити
1. Разделение меню на "Вход/поставка" и "Выход/отгрузка"
2. Реализация календаря с улучшенной навигацией
3. Добавление валидации и подсказок
### Этап 4: Оптимизации
1. Быстрый режим для повторяющихся операций
2. Шаблоны поставок
3. Аналитика и отчеты по использованию